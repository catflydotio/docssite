<p>Microservices have gained widespread adoption in the past decade, but they present their own set of challenges. Traffic control, authentication, logging, and rate limiting are essential in distributed architectures, but not easy to manage when your organization runs dozens or hundreds of APIs.</p>
<p><a href="https://konghq.com/kong/">Kong</a> provides an excellent solution to these problems. It&#39;s an open-source API gateway that sits between your users and backend services. By proxying requests through Kong, you can enforce standardized authentication rules, log requests and errors, and even transform data on the fly.</p>
<p>Kong can be deployed to a central server, but this slows down your application because all your web requests must pass through a central location before being sent to your backing services. Fortunately, you can take advantage of <a href="https://fly.io/">Fly&#39;s edge hosting model</a> to improve performance by serving Kong on Fly&#39;s globally distributed network.</p>
<p><img src="https://raw.githubusercontent.com/fly-examples/kong-api-gateway/main/fly-2020-07-22-a.jpg" alt="Running a distributed Kong API Gateway on Fly.io" /></p>
<h2 id='how-to-deploy-a-kong-api-gateway-to-fly' class='group flex items-center whitespace-pre-wrap relative mt-14 mb-6 text-navy font-heading'><a class='absolute ml-[-1em] pr-[0.5em] after:hash opacity-0 group-hover:opacity-50 transition-all' href='#how-to-deploy-a-kong-api-gateway-to-fly' aria-label='Anchor'></a>How to Deploy a Kong API Gateway to Fly</h2><p>In this tutorial, you&#39;ll see how to deploy a Kong API Gateway to Fly.io. You&#39;ll expose the free <a href="https://jsonplaceholder.typicode.com/">JSON Placeholder</a> as a backend service and use Kong to add rate limiting and API key authentication. Finally, you&#39;ll see how to lock down the Kong Admin API so that only authenticated users can access it. You&#39;ll see all the steps required in this tutorial, but if you&#39;d like to download the final working application, it&#39;s <a href="https://github.com/karllhughes/fly-kong">available on Github</a>.</p>
<h3 id='prerequisites' class='group flex items-center whitespace-pre-wrap relative mt-14 mb-6 text-navy font-heading'><a class='absolute ml-[-1em] pr-[0.5em] after:hash opacity-0 group-hover:opacity-50 transition-all' href='#prerequisites' aria-label='Anchor'></a>Prerequisites</h3>
<ul>
<li><a href="https://fly.io/docs/flyctl/installing/">Flyctl command line tool</a>.
</li><li><a href="https://www.postgresql.org/">A Postgres database</a> that is publicly available and allows connections (I created one on <a href="https://devcenter.heroku.com/articles/heroku-postgresql">Heroku</a>). Kong will use this as a central data store.
</li><li><a href="https://www.docker.com/products/docker-desktop">Docker</a> for running the one-time Kong database migrations.
</li></ul>
<h3 id='creating-a-new-fly-application' class='group flex items-center whitespace-pre-wrap relative mt-14 mb-6 text-navy font-heading'><a class='absolute ml-[-1em] pr-[0.5em] after:hash opacity-0 group-hover:opacity-50 transition-all' href='#creating-a-new-fly-application' aria-label='Anchor'></a>Creating a New Fly Application</h3><p>First, you&#39;ll need to use <code>flyctl</code> to create a new application. If you haven&#39;t already, install the appropriate version of <code>flyctl</code> for your operating system using the <a href="https://fly.io/docs/hands-on/installing/">instructions here</a>.</p>
<p>Next, <a href="https://fly.io/docs/hands-on/sign-up/">sign up</a> or <a href="https://fly.io/docs/hands-on/sign-in/">sign in</a> to your Fly account via the command line:</p>
<div class='highlight relative group '><button class='group-hover:opacity-100 opacity-0 transition-all absolute right-0 top-0 z-20 w-12 h-12 p-4 text-gray-400 hover:text-white z-10 outline-none focus:outline-none' aria-label='Copy' data-copy-target='sibling' data-copy-success="%3Csvg viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg' stroke-linecap='round' stroke-width='2' stroke='white' fill='none' stroke='currentColor' %3E%3Cpath d='m16.376 7.924-6.043 8.095-2.895-3.354' /%3E%3Cpath d='M6 2h12c2.208 0 4 1.792 4 4v12c0 2.208-1.792 4-4 4H6c-2.208 0-4-1.792-4-4V6c0-2.208 1.792-4 4-4Z' /%3E%3C/svg%3E"><svg class='pointer-events-none' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'><path d='M15.79 10.869a2.66 2.66 0 0 0-2.659-2.659H5.154a2.66 2.66 0 0 0-2.659 2.659v7.977a2.66 2.66 0 0 0 2.659 2.659h7.977a2.66 2.66 0 0 0 2.659-2.659v-7.977Z' /><path d='M15.79 15.758h3.089a2.661 2.661 0 0 0 2.659-2.66V5.121a2.661 2.661 0 0 0-2.659-2.659h-7.977a2.661 2.661 0 0 0-2.66 2.659v2.368' /></svg></button><pre class='highlight bash'><code><span class="c"># Sign up</span>
flyctl auth signup

<span class="c"># Or sign in</span>
flyctl auth login
</code></pre></div><p>You will be directed to a web page that will allow you to log in using your Github account or email and password.</p>
<p>Create a new directory called <code>fly-kong</code> and create your new app inside of it:</p>
<div class='highlight relative group '><button class='group-hover:opacity-100 opacity-0 transition-all absolute right-0 top-0 z-20 w-12 h-12 p-4 text-gray-400 hover:text-white z-10 outline-none focus:outline-none' aria-label='Copy' data-copy-target='sibling' data-copy-success="%3Csvg viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg' stroke-linecap='round' stroke-width='2' stroke='white' fill='none' stroke='currentColor' %3E%3Cpath d='m16.376 7.924-6.043 8.095-2.895-3.354' /%3E%3Cpath d='M6 2h12c2.208 0 4 1.792 4 4v12c0 2.208-1.792 4-4 4H6c-2.208 0-4-1.792-4-4V6c0-2.208 1.792-4 4-4Z' /%3E%3C/svg%3E"><svg class='pointer-events-none' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'><path d='M15.79 10.869a2.66 2.66 0 0 0-2.659-2.659H5.154a2.66 2.66 0 0 0-2.659 2.659v7.977a2.66 2.66 0 0 0 2.659 2.659h7.977a2.66 2.66 0 0 0 2.659-2.659v-7.977Z' /><path d='M15.79 15.758h3.089a2.661 2.661 0 0 0 2.659-2.66V5.121a2.661 2.661 0 0 0-2.659-2.659h-7.977a2.661 2.661 0 0 0-2.66 2.659v2.368' /></svg></button><pre class='highlight bash'><code><span class="nb">mkdir </span>fly-kong <span class="o">&amp;&amp;</span> <span class="nb">cd </span>fly-kong
flyctl apps create
</code></pre></div><p>Use the auto-generated app name, select your organization, and select <code>Dockerfile</code> as your builder. You should see output similar to this in your console:</p>
<div class='highlight relative group '><button class='group-hover:opacity-100 opacity-0 transition-all absolute right-0 top-0 z-20 w-12 h-12 p-4 text-gray-400 hover:text-white z-10 outline-none focus:outline-none' aria-label='Copy' data-copy-target='sibling' data-copy-success="%3Csvg viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg' stroke-linecap='round' stroke-width='2' stroke='white' fill='none' stroke='currentColor' %3E%3Cpath d='m16.376 7.924-6.043 8.095-2.895-3.354' /%3E%3Cpath d='M6 2h12c2.208 0 4 1.792 4 4v12c0 2.208-1.792 4-4 4H6c-2.208 0-4-1.792-4-4V6c0-2.208 1.792-4 4-4Z' /%3E%3C/svg%3E"><svg class='pointer-events-none' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'><path d='M15.79 10.869a2.66 2.66 0 0 0-2.659-2.659H5.154a2.66 2.66 0 0 0-2.659 2.659v7.977a2.66 2.66 0 0 0 2.659 2.659h7.977a2.66 2.66 0 0 0 2.659-2.659v-7.977Z' /><path d='M15.79 15.758h3.089a2.661 2.661 0 0 0 2.659-2.66V5.121a2.661 2.661 0 0 0-2.659-2.659h-7.977a2.661 2.661 0 0 0-2.66 2.659v2.368' /></svg></button><pre class='highlight bash'><code>? App Name <span class="o">(</span>leave blank to use an auto-generated name<span class="o">)</span> 

? Select organization: YOUR ORGANIZATION

? Select builder: Dockerfile
    <span class="o">(</span>Create an example Dockerfile<span class="o">)</span>

New app created
  Name     <span class="o">=</span> &lt;your-app-name&gt;  
  Owner    <span class="o">=</span> &lt;your-name&gt;
  Version  <span class="o">=</span> 0               
  Status   <span class="o">=</span>                 
  Hostname <span class="o">=</span> &lt;empty&gt;         

Wrote config file fly.toml
</code></pre></div><p>Fly will create a <code>fly.toml</code> file and <code>Dockerfile</code> in the root of your project.</p>
<p>Open the <code>fly.toml</code> file and modify the <code>[[services]]</code> portion:</p>
<div class='highlight relative group '><button class='group-hover:opacity-100 opacity-0 transition-all absolute right-0 top-0 z-20 w-12 h-12 p-4 text-gray-400 hover:text-white z-10 outline-none focus:outline-none' aria-label='Copy' data-copy-target='sibling' data-copy-success="%3Csvg viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg' stroke-linecap='round' stroke-width='2' stroke='white' fill='none' stroke='currentColor' %3E%3Cpath d='m16.376 7.924-6.043 8.095-2.895-3.354' /%3E%3Cpath d='M6 2h12c2.208 0 4 1.792 4 4v12c0 2.208-1.792 4-4 4H6c-2.208 0-4-1.792-4-4V6c0-2.208 1.792-4 4-4Z' /%3E%3C/svg%3E"><svg class='pointer-events-none' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'><path d='M15.79 10.869a2.66 2.66 0 0 0-2.659-2.659H5.154a2.66 2.66 0 0 0-2.659 2.659v7.977a2.66 2.66 0 0 0 2.659 2.659h7.977a2.66 2.66 0 0 0 2.659-2.659v-7.977Z' /><path d='M15.79 15.758h3.089a2.661 2.661 0 0 0 2.659-2.66V5.121a2.661 2.661 0 0 0-2.659-2.659h-7.977a2.661 2.661 0 0 0-2.66 2.659v2.368' /></svg></button><pre class='highlight toml'><code><span class="err">...</span>
<span class="c"># Kong Gateway</span>
<span class="nn">[[services]]</span>
  <span class="py">internal_port</span> <span class="p">=</span> <span class="mi">8000</span>
  <span class="py">protocol</span> <span class="p">=</span> <span class="s">"tcp"</span>

  <span class="nn">[[services.ports]]</span>
    <span class="py">handlers</span> <span class="p">=</span> <span class="p">[</span><span class="s">"tls"</span><span class="p">,</span> <span class="s">"http"</span><span class="p">]</span>
    <span class="py">port</span> <span class="p">=</span> <span class="s">"443"</span>

<span class="c"># Kong Admin</span>
<span class="nn">[[services]]</span>
  <span class="py">internal_port</span> <span class="p">=</span> <span class="mi">8001</span>
  <span class="py">protocol</span> <span class="p">=</span> <span class="s">"tcp"</span>

  <span class="nn">[[services.ports]]</span>
    <span class="py">handlers</span> <span class="p">=</span> <span class="p">[</span><span class="s">"tls"</span><span class="p">,</span> <span class="s">"http"</span><span class="p">]</span>
    <span class="py">port</span> <span class="p">=</span> <span class="s">"10001"</span>
</code></pre></div><p>This will open two ports on your Fly deployment. The first handles standard SSL traffic and routes it to the Kong API Gateway, and the second handles traffic to port <code>10001</code>, which you&#39;ll use for the <a href="https://docs.konghq.com/2.0.x/admin-api/">Kong Admin API</a>.</p>
<p>Because of the <a href="https://github.com/moby/moby/issues/31243">filesystem permissions required for writing to the <code>/dev/std*</code> logs</a>, you need to run the container as <code>root</code>. Open up the <code>Dockerfile</code> and replace it with the following:</p>
<div class='highlight relative group '><button class='group-hover:opacity-100 opacity-0 transition-all absolute right-0 top-0 z-20 w-12 h-12 p-4 text-gray-400 hover:text-white z-10 outline-none focus:outline-none' aria-label='Copy' data-copy-target='sibling' data-copy-success="%3Csvg viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg' stroke-linecap='round' stroke-width='2' stroke='white' fill='none' stroke='currentColor' %3E%3Cpath d='m16.376 7.924-6.043 8.095-2.895-3.354' /%3E%3Cpath d='M6 2h12c2.208 0 4 1.792 4 4v12c0 2.208-1.792 4-4 4H6c-2.208 0-4-1.792-4-4V6c0-2.208 1.792-4 4-4Z' /%3E%3C/svg%3E"><svg class='pointer-events-none' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'><path d='M15.79 10.869a2.66 2.66 0 0 0-2.659-2.659H5.154a2.66 2.66 0 0 0-2.659 2.659v7.977a2.66 2.66 0 0 0 2.659 2.659h7.977a2.66 2.66 0 0 0 2.659-2.659v-7.977Z' /><path d='M15.79 15.758h3.089a2.661 2.661 0 0 0 2.659-2.66V5.121a2.661 2.661 0 0 0-2.659-2.659h-7.977a2.661 2.661 0 0 0-2.66 2.659v2.368' /></svg></button><pre class='highlight Dockerfile'><code><span class="k">FROM</span><span class="s"> kong:latest</span>
<span class="k">USER</span><span class="s"> root</span>
</code></pre></div><p>Your application configuration is now ready, but you still need to set up the database before you can run Kong.</p>
<h3 id='preparing-your-database' class='group flex items-center whitespace-pre-wrap relative mt-14 mb-6 text-navy font-heading'><a class='absolute ml-[-1em] pr-[0.5em] after:hash opacity-0 group-hover:opacity-50 transition-all' href='#preparing-your-database' aria-label='Anchor'></a>Preparing Your Database</h3><p>Before you can use your Kong API Gateway, you&#39;ll need run the <a href="https://docs.konghq.com/install/docker/">Kong database migrations</a>. You can do this using Docker:</p>
<div class='highlight relative group '><button class='group-hover:opacity-100 opacity-0 transition-all absolute right-0 top-0 z-20 w-12 h-12 p-4 text-gray-400 hover:text-white z-10 outline-none focus:outline-none' aria-label='Copy' data-copy-target='sibling' data-copy-success="%3Csvg viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg' stroke-linecap='round' stroke-width='2' stroke='white' fill='none' stroke='currentColor' %3E%3Cpath d='m16.376 7.924-6.043 8.095-2.895-3.354' /%3E%3Cpath d='M6 2h12c2.208 0 4 1.792 4 4v12c0 2.208-1.792 4-4 4H6c-2.208 0-4-1.792-4-4V6c0-2.208 1.792-4 4-4Z' /%3E%3C/svg%3E"><svg class='pointer-events-none' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'><path d='M15.79 10.869a2.66 2.66 0 0 0-2.659-2.659H5.154a2.66 2.66 0 0 0-2.659 2.659v7.977a2.66 2.66 0 0 0 2.659 2.659h7.977a2.66 2.66 0 0 0 2.659-2.659v-7.977Z' /><path d='M15.79 15.758h3.089a2.661 2.661 0 0 0 2.659-2.66V5.121a2.661 2.661 0 0 0-2.659-2.659h-7.977a2.661 2.661 0 0 0-2.66 2.659v2.368' /></svg></button><pre class='highlight bash'><code>docker run <span class="nt">--rm</span> <span class="se">\</span>
     <span class="nt">-e</span> <span class="s2">"KONG_DATABASE=postgres"</span> <span class="se">\</span>
     <span class="nt">-e</span> <span class="s2">"KONG_PG_HOST=&lt;database-host&gt;"</span> <span class="se">\</span>
     <span class="nt">-e</span> <span class="s2">"KONG_PG_DATABASE=&lt;database-name&gt;"</span> <span class="se">\</span>
     <span class="nt">-e</span> <span class="s2">"KONG_PG_PORT=&lt;database-port&gt;"</span> <span class="se">\</span>
     <span class="nt">-e</span> <span class="s2">"KONG_PG_USER=&lt;database-user&gt;"</span> <span class="se">\</span>
     <span class="nt">-e</span> <span class="s2">"KONG_PG_PASSWORD=&lt;database-password&gt;"</span> <span class="se">\</span>
     <span class="nt">-e</span> <span class="s2">"KONG_PG_SSL=on"</span> <span class="se">\</span>
     kong:latest kong migrations bootstrap
</code></pre></div><p>Kong uses this database to persist data about your Services, Routes, and Consumers across the Fly hosting network. Once the database migrations have run, you&#39;re ready to start Kong on Fly.</p>
<h3 id='starting-kong' class='group flex items-center whitespace-pre-wrap relative mt-14 mb-6 text-navy font-heading'><a class='absolute ml-[-1em] pr-[0.5em] after:hash opacity-0 group-hover:opacity-50 transition-all' href='#starting-kong' aria-label='Anchor'></a>Starting Kong</h3><p>Your Fly instance will connect to the Postgres database you prepared in the previous step, but first, you need to add your database connection credentials to Fly as <a href="https://fly.io/docs/flyctl/secrets/">application secrets</a>.</p>
<p>Run the following in your terminal:</p>
<div class='highlight relative group '><button class='group-hover:opacity-100 opacity-0 transition-all absolute right-0 top-0 z-20 w-12 h-12 p-4 text-gray-400 hover:text-white z-10 outline-none focus:outline-none' aria-label='Copy' data-copy-target='sibling' data-copy-success="%3Csvg viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg' stroke-linecap='round' stroke-width='2' stroke='white' fill='none' stroke='currentColor' %3E%3Cpath d='m16.376 7.924-6.043 8.095-2.895-3.354' /%3E%3Cpath d='M6 2h12c2.208 0 4 1.792 4 4v12c0 2.208-1.792 4-4 4H6c-2.208 0-4-1.792-4-4V6c0-2.208 1.792-4 4-4Z' /%3E%3C/svg%3E"><svg class='pointer-events-none' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'><path d='M15.79 10.869a2.66 2.66 0 0 0-2.659-2.659H5.154a2.66 2.66 0 0 0-2.659 2.659v7.977a2.66 2.66 0 0 0 2.659 2.659h7.977a2.66 2.66 0 0 0 2.659-2.659v-7.977Z' /><path d='M15.79 15.758h3.089a2.661 2.661 0 0 0 2.659-2.66V5.121a2.661 2.661 0 0 0-2.659-2.659h-7.977a2.661 2.661 0 0 0-2.66 2.659v2.368' /></svg></button><pre class='highlight bash'><code>flyctl secrets <span class="nb">set</span> <span class="se">\</span>
    <span class="nv">KONG_DATABASE</span><span class="o">=</span><span class="s2">"postgres"</span> <span class="se">\</span>
    <span class="nv">KONG_PG_HOST</span><span class="o">=</span><span class="s2">"&lt;database-host&gt;"</span> <span class="se">\</span>
    <span class="nv">KONG_PG_DATABASE</span><span class="o">=</span><span class="s2">"&lt;database-name&gt;"</span> <span class="se">\</span>
    <span class="nv">KONG_PG_PORT</span><span class="o">=</span><span class="s2">"&lt;database-port&gt;"</span> <span class="se">\</span>
    <span class="nv">KONG_PG_USER</span><span class="o">=</span><span class="s2">"&lt;database-user&gt;"</span> <span class="se">\</span>
    <span class="nv">KONG_PG_PASSWORD</span><span class="o">=</span><span class="s2">"&lt;database-password&gt;"</span> <span class="se">\</span>
    <span class="nv">KONG_PG_SSL</span><span class="o">=</span><span class="s2">"on"</span> <span class="se">\</span>
    <span class="nv">KONG_PROXY_ACCESS_LOG</span><span class="o">=</span><span class="s2">"/dev/stdout"</span> <span class="se">\</span>
    <span class="nv">KONG_ADMIN_ACCESS_LOG</span><span class="o">=</span><span class="s2">"/dev/stdout"</span> <span class="se">\</span>
    <span class="nv">KONG_PROXY_ERROR_LOG</span><span class="o">=</span><span class="s2">"/dev/stderr"</span> <span class="se">\</span>
    <span class="nv">KONG_ADMIN_ERROR_LOG</span><span class="o">=</span><span class="s2">"/dev/stderr"</span> <span class="se">\</span>
    <span class="nv">KONG_ADMIN_LISTEN</span><span class="o">=</span><span class="s2">"0.0.0.0:8001"</span>
</code></pre></div><p>This command adds the database connection, logging, and admin API details to your Fly environment. Now you&#39;re ready to deploy Kong:</p>
<div class='highlight relative group '><button class='group-hover:opacity-100 opacity-0 transition-all absolute right-0 top-0 z-20 w-12 h-12 p-4 text-gray-400 hover:text-white z-10 outline-none focus:outline-none' aria-label='Copy' data-copy-target='sibling' data-copy-success="%3Csvg viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg' stroke-linecap='round' stroke-width='2' stroke='white' fill='none' stroke='currentColor' %3E%3Cpath d='m16.376 7.924-6.043 8.095-2.895-3.354' /%3E%3Cpath d='M6 2h12c2.208 0 4 1.792 4 4v12c0 2.208-1.792 4-4 4H6c-2.208 0-4-1.792-4-4V6c0-2.208 1.792-4 4-4Z' /%3E%3C/svg%3E"><svg class='pointer-events-none' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'><path d='M15.79 10.869a2.66 2.66 0 0 0-2.659-2.659H5.154a2.66 2.66 0 0 0-2.659 2.659v7.977a2.66 2.66 0 0 0 2.659 2.659h7.977a2.66 2.66 0 0 0 2.659-2.659v-7.977Z' /><path d='M15.79 15.758h3.089a2.661 2.661 0 0 0 2.659-2.66V5.121a2.661 2.661 0 0 0-2.659-2.659h-7.977a2.661 2.661 0 0 0-2.66 2.659v2.368' /></svg></button><pre class='highlight bash'><code>flyctl deploy
</code></pre></div><p>You should see output similar to the following in your terminal:</p>
<div class='highlight relative group '><button class='group-hover:opacity-100 opacity-0 transition-all absolute right-0 top-0 z-20 w-12 h-12 p-4 text-gray-400 hover:text-white z-10 outline-none focus:outline-none' aria-label='Copy' data-copy-target='sibling' data-copy-success="%3Csvg viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg' stroke-linecap='round' stroke-width='2' stroke='white' fill='none' stroke='currentColor' %3E%3Cpath d='m16.376 7.924-6.043 8.095-2.895-3.354' /%3E%3Cpath d='M6 2h12c2.208 0 4 1.792 4 4v12c0 2.208-1.792 4-4 4H6c-2.208 0-4-1.792-4-4V6c0-2.208 1.792-4 4-4Z' /%3E%3C/svg%3E"><svg class='pointer-events-none' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'><path d='M15.79 10.869a2.66 2.66 0 0 0-2.659-2.659H5.154a2.66 2.66 0 0 0-2.659 2.659v7.977a2.66 2.66 0 0 0 2.659 2.659h7.977a2.66 2.66 0 0 0 2.659-2.659v-7.977Z' /><path d='M15.79 15.758h3.089a2.661 2.661 0 0 0 2.659-2.66V5.121a2.661 2.661 0 0 0-2.659-2.659h-7.977a2.661 2.661 0 0 0-2.66 2.659v2.368' /></svg></button><pre class='highlight '><code>Deploying &lt;your-app-name&gt;
==&gt; Validating App Configuration
--&gt; Validating App Configuration done
Services
TCP 443 ⇢ 8000   
TCP 10001 ⇢ 8001 

Deploy source directory '/Users/karl/fly-kong'
Docker daemon available, performing local build...
==&gt; Building with Dockerfile
Using Dockerfile: /Users/karl/fly-kong/Dockerfile
...
--&gt; Done Pushing Image
==&gt; Optimizing Image
--&gt; Done Optimizing Image
==&gt; Creating Release
Release v26 created
Monitoring Deployment
You can detach the terminal anytime without stopping the deployment

1 desired, 2 placed, 1 healthy, 0 unhealthy
--&gt; v1 deployed successfully
</code></pre></div><p>You can visit your newly created Kong deployment at <code>https://&lt;your-app-name&gt;.fly.dev</code>, but all you&#39;ll see is the message, &quot;no Route matched with those values.&quot; In the next section, you&#39;ll see how to set up Services, Routes, and Plugins using the Kong Admin API.</p>
<h2 id='using-kong-to-secure-an-api' class='group flex items-center whitespace-pre-wrap relative mt-14 mb-6 text-navy font-heading'><a class='absolute ml-[-1em] pr-[0.5em] after:hash opacity-0 group-hover:opacity-50 transition-all' href='#using-kong-to-secure-an-api' aria-label='Anchor'></a>Using Kong to Secure an API</h2><p>You have a working instance of Kong deployed to Fly, but it&#39;s not useful without any <a href="https://docs.konghq.com/2.0.x/getting-started/configuring-a-service/">Services or Routes</a>. In this section, you&#39;ll see how to add a Service and configure rate limiting and API key authentication. Finally, you&#39;ll secure the Kong Admin API to prevent unauthorized access to your Gateway&#39;s configuration.</p>
<h3 id='adding-a-backend-service' class='group flex items-center whitespace-pre-wrap relative mt-14 mb-6 text-navy font-heading'><a class='absolute ml-[-1em] pr-[0.5em] after:hash opacity-0 group-hover:opacity-50 transition-all' href='#adding-a-backend-service' aria-label='Anchor'></a>Adding a Backend Service</h3><p>Kong will proxy web requests it receives to any backend API you set up. To demonstrate this functionality, you&#39;ll create a new service that proxies requests to <a href="https://jsonplaceholder.typicode.com/">JSON Placeholder</a>. This free service returns a JSON payload similar to what you might find when connecting to a REST API.</p>
<p>To add JSON Placeholder&#39;s <code>/posts</code> resource as a service named <code>posts</code>, use <a href="https://curl.haxx.se/">curl</a> to post it to the Kong Admin API:</p>
<div class='highlight relative group '><button class='group-hover:opacity-100 opacity-0 transition-all absolute right-0 top-0 z-20 w-12 h-12 p-4 text-gray-400 hover:text-white z-10 outline-none focus:outline-none' aria-label='Copy' data-copy-target='sibling' data-copy-success="%3Csvg viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg' stroke-linecap='round' stroke-width='2' stroke='white' fill='none' stroke='currentColor' %3E%3Cpath d='m16.376 7.924-6.043 8.095-2.895-3.354' /%3E%3Cpath d='M6 2h12c2.208 0 4 1.792 4 4v12c0 2.208-1.792 4-4 4H6c-2.208 0-4-1.792-4-4V6c0-2.208 1.792-4 4-4Z' /%3E%3C/svg%3E"><svg class='pointer-events-none' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'><path d='M15.79 10.869a2.66 2.66 0 0 0-2.659-2.659H5.154a2.66 2.66 0 0 0-2.659 2.659v7.977a2.66 2.66 0 0 0 2.659 2.659h7.977a2.66 2.66 0 0 0 2.659-2.659v-7.977Z' /><path d='M15.79 15.758h3.089a2.661 2.661 0 0 0 2.659-2.66V5.121a2.661 2.661 0 0 0-2.659-2.659h-7.977a2.661 2.661 0 0 0-2.66 2.659v2.368' /></svg></button><pre class='highlight bash'><code>curl <span class="nt">-i</span> <span class="nt">-X</span> POST https://&lt;your-app-name&gt;.fly.dev:10001/services <span class="se">\</span>
 <span class="nt">--data</span> <span class="nv">name</span><span class="o">=</span>posts <span class="se">\</span>
 <span class="nt">--data</span> <span class="nv">url</span><span class="o">=</span><span class="s1">'https://jsonplaceholder.typicode.com/posts'</span>
</code></pre></div><p>Next, create a Route in Kong. Routes specify access points for your services, so in this case, the route will be <code>/posts</code>, and it will act as a proxy for the <code>posts</code> Service you just created:</p>
<div class='highlight relative group '><button class='group-hover:opacity-100 opacity-0 transition-all absolute right-0 top-0 z-20 w-12 h-12 p-4 text-gray-400 hover:text-white z-10 outline-none focus:outline-none' aria-label='Copy' data-copy-target='sibling' data-copy-success="%3Csvg viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg' stroke-linecap='round' stroke-width='2' stroke='white' fill='none' stroke='currentColor' %3E%3Cpath d='m16.376 7.924-6.043 8.095-2.895-3.354' /%3E%3Cpath d='M6 2h12c2.208 0 4 1.792 4 4v12c0 2.208-1.792 4-4 4H6c-2.208 0-4-1.792-4-4V6c0-2.208 1.792-4 4-4Z' /%3E%3C/svg%3E"><svg class='pointer-events-none' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'><path d='M15.79 10.869a2.66 2.66 0 0 0-2.659-2.659H5.154a2.66 2.66 0 0 0-2.659 2.659v7.977a2.66 2.66 0 0 0 2.659 2.659h7.977a2.66 2.66 0 0 0 2.659-2.659v-7.977Z' /><path d='M15.79 15.758h3.089a2.661 2.661 0 0 0 2.659-2.66V5.121a2.661 2.661 0 0 0-2.659-2.659h-7.977a2.661 2.661 0 0 0-2.66 2.659v2.368' /></svg></button><pre class='highlight bash'><code>curl <span class="nt">-i</span> <span class="nt">-X</span> POST https://&lt;your-app-name&gt;.fly.dev:10001/services/posts/routes <span class="se">\</span>
  <span class="nt">--data</span> <span class="s1">'paths[]=/posts'</span>
</code></pre></div><p>Kong&#39;s Admin API gives you REST access to all the Kong resources saved in the database, so be sure to <a href="https://docs.konghq.com/2.0.x/admin-api/">check out the documentation</a> to learn more.</p>
<p>Now that you have a Route connected to a Service, you can test it out on your deployment. Visit <code>https://&lt;your-app-name&gt;.fly.dev/posts</code> to see the <code>/posts</code> payload from JSON Placeholder:</p>
<div class='highlight relative group '><button class='group-hover:opacity-100 opacity-0 transition-all absolute right-0 top-0 z-20 w-12 h-12 p-4 text-gray-400 hover:text-white z-10 outline-none focus:outline-none' aria-label='Copy' data-copy-target='sibling' data-copy-success="%3Csvg viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg' stroke-linecap='round' stroke-width='2' stroke='white' fill='none' stroke='currentColor' %3E%3Cpath d='m16.376 7.924-6.043 8.095-2.895-3.354' /%3E%3Cpath d='M6 2h12c2.208 0 4 1.792 4 4v12c0 2.208-1.792 4-4 4H6c-2.208 0-4-1.792-4-4V6c0-2.208 1.792-4 4-4Z' /%3E%3C/svg%3E"><svg class='pointer-events-none' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'><path d='M15.79 10.869a2.66 2.66 0 0 0-2.659-2.659H5.154a2.66 2.66 0 0 0-2.659 2.659v7.977a2.66 2.66 0 0 0 2.659 2.659h7.977a2.66 2.66 0 0 0 2.659-2.659v-7.977Z' /><path d='M15.79 15.758h3.089a2.661 2.661 0 0 0 2.659-2.66V5.121a2.661 2.661 0 0 0-2.659-2.659h-7.977a2.661 2.661 0 0 0-2.66 2.659v2.368' /></svg></button><pre class='highlight json'><code><span class="p">[</span><span class="w">
  </span><span class="p">{</span><span class="w">
    </span><span class="nl">"userId"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
    </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
    </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sunt aut facere repellat provident occaecati excepturi optio reprehenderit"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"body"</span><span class="p">:</span><span class="w"> </span><span class="s2">"quia et suscipit</span><span class="se">\n</span><span class="s2">suscipit recusandae consequuntur expedita et cum</span><span class="se">\n</span><span class="s2">reprehenderit molestiae ut ut quas totam</span><span class="se">\n</span><span class="s2">nostrum rerum est autem sunt rem eveniet architecto"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="err">...</span><span class="w">
</span></code></pre></div><p>You can also retrieve the access logs using <code>flyctl logs</code>.</p>
<h3 id='rate-limiting-access' class='group flex items-center whitespace-pre-wrap relative mt-14 mb-6 text-navy font-heading'><a class='absolute ml-[-1em] pr-[0.5em] after:hash opacity-0 group-hover:opacity-50 transition-all' href='#rate-limiting-access' aria-label='Anchor'></a>Rate Limiting Access</h3><p>If you&#39;re exposing your API publicly, rate limiting your users is probably a good idea. You can use <a href="https://docs.konghq.com/getting-started-guide/ce-2.0.x_ke-1.5.x/protect-services/">Kong&#39;s Rate Limiting plugin</a> to ensure that users can&#39;t abuse your API by repeatedly calling the same endpoint. This encourages users to cache responses and can save significant load on your servers.</p>
<p>To add the Rate Limiting plugin, use the Kong Admin API again:</p>
<div class='highlight relative group '><button class='group-hover:opacity-100 opacity-0 transition-all absolute right-0 top-0 z-20 w-12 h-12 p-4 text-gray-400 hover:text-white z-10 outline-none focus:outline-none' aria-label='Copy' data-copy-target='sibling' data-copy-success="%3Csvg viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg' stroke-linecap='round' stroke-width='2' stroke='white' fill='none' stroke='currentColor' %3E%3Cpath d='m16.376 7.924-6.043 8.095-2.895-3.354' /%3E%3Cpath d='M6 2h12c2.208 0 4 1.792 4 4v12c0 2.208-1.792 4-4 4H6c-2.208 0-4-1.792-4-4V6c0-2.208 1.792-4 4-4Z' /%3E%3C/svg%3E"><svg class='pointer-events-none' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'><path d='M15.79 10.869a2.66 2.66 0 0 0-2.659-2.659H5.154a2.66 2.66 0 0 0-2.659 2.659v7.977a2.66 2.66 0 0 0 2.659 2.659h7.977a2.66 2.66 0 0 0 2.659-2.659v-7.977Z' /><path d='M15.79 15.758h3.089a2.661 2.661 0 0 0 2.659-2.66V5.121a2.661 2.661 0 0 0-2.659-2.659h-7.977a2.661 2.661 0 0 0-2.66 2.659v2.368' /></svg></button><pre class='highlight bash'><code>curl <span class="nt">-i</span> <span class="nt">-X</span> POST https://&lt;your-app-name&gt;.fly.dev:10001/services/posts/plugins <span class="se">\</span>
<span class="nt">--data</span> <span class="s2">"name=rate-limiting"</span> <span class="se">\</span>
<span class="nt">--data</span> <span class="s2">"config.minute=5"</span> <span class="se">\</span>
<span class="nt">--data</span> <span class="s2">"config.policy=local"</span>
</code></pre></div><p>The policy above restricts users to 5 API calls per minute per node. You could also limit users to a certain number of API calls for all nodes, but this requires storage in the central database. Since Fly is directing requests to the nearest node anyway, <code>local</code> is fine for this use case.</p>
<p>To test the rate limiting out, go to <code>https://&lt;your-app-name&gt;.fly.dev/posts</code> in your browser and hit refresh six times in a row. On the 6th refresh, you should see the message, &quot;API rate limit exceeded.&quot;</p>
<h3 id='api-key-authentication' class='group flex items-center whitespace-pre-wrap relative mt-14 mb-6 text-navy font-heading'><a class='absolute ml-[-1em] pr-[0.5em] after:hash opacity-0 group-hover:opacity-50 transition-all' href='#api-key-authentication' aria-label='Anchor'></a>API Key Authentication</h3><p>If your API is only going to be used by trusted consumers, you should limit access using API Keys or <a href="https://docs.konghq.com/2.0.x/auth/">another form of authentication</a>. To add authentication to the <code>/posts</code> Route, you can use curl again to post to the Kong Admin API:</p>
<div class='highlight relative group '><button class='group-hover:opacity-100 opacity-0 transition-all absolute right-0 top-0 z-20 w-12 h-12 p-4 text-gray-400 hover:text-white z-10 outline-none focus:outline-none' aria-label='Copy' data-copy-target='sibling' data-copy-success="%3Csvg viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg' stroke-linecap='round' stroke-width='2' stroke='white' fill='none' stroke='currentColor' %3E%3Cpath d='m16.376 7.924-6.043 8.095-2.895-3.354' /%3E%3Cpath d='M6 2h12c2.208 0 4 1.792 4 4v12c0 2.208-1.792 4-4 4H6c-2.208 0-4-1.792-4-4V6c0-2.208 1.792-4 4-4Z' /%3E%3C/svg%3E"><svg class='pointer-events-none' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'><path d='M15.79 10.869a2.66 2.66 0 0 0-2.659-2.659H5.154a2.66 2.66 0 0 0-2.659 2.659v7.977a2.66 2.66 0 0 0 2.659 2.659h7.977a2.66 2.66 0 0 0 2.659-2.659v-7.977Z' /><path d='M15.79 15.758h3.089a2.661 2.661 0 0 0 2.659-2.66V5.121a2.661 2.661 0 0 0-2.659-2.659h-7.977a2.661 2.661 0 0 0-2.66 2.659v2.368' /></svg></button><pre class='highlight bash'><code>curl <span class="nt">-i</span> <span class="nt">-X</span> POST <span class="se">\</span>
   <span class="nt">--url</span> https://&lt;your-app-name&gt;.fly.dev:10001/services/posts/plugins/ <span class="se">\</span>
   <span class="nt">--data</span> <span class="s1">'name=key-auth'</span>
   <span class="nt">--data</span> <span class="s1">'config.hide_credentials=true'</span>
</code></pre></div><p>To test this out, you&#39;ll also need a <a href="https://docs.konghq.com/2.0.x/getting-started/adding-consumers/">Consumer</a> with an API key. Create a user called <code>admin</code> using the Kong Admin API:</p>
<div class='highlight relative group '><button class='group-hover:opacity-100 opacity-0 transition-all absolute right-0 top-0 z-20 w-12 h-12 p-4 text-gray-400 hover:text-white z-10 outline-none focus:outline-none' aria-label='Copy' data-copy-target='sibling' data-copy-success="%3Csvg viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg' stroke-linecap='round' stroke-width='2' stroke='white' fill='none' stroke='currentColor' %3E%3Cpath d='m16.376 7.924-6.043 8.095-2.895-3.354' /%3E%3Cpath d='M6 2h12c2.208 0 4 1.792 4 4v12c0 2.208-1.792 4-4 4H6c-2.208 0-4-1.792-4-4V6c0-2.208 1.792-4 4-4Z' /%3E%3C/svg%3E"><svg class='pointer-events-none' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'><path d='M15.79 10.869a2.66 2.66 0 0 0-2.659-2.659H5.154a2.66 2.66 0 0 0-2.659 2.659v7.977a2.66 2.66 0 0 0 2.659 2.659h7.977a2.66 2.66 0 0 0 2.659-2.659v-7.977Z' /><path d='M15.79 15.758h3.089a2.661 2.661 0 0 0 2.659-2.66V5.121a2.661 2.661 0 0 0-2.659-2.659h-7.977a2.661 2.661 0 0 0-2.66 2.659v2.368' /></svg></button><pre class='highlight bash'><code>curl <span class="nt">-i</span> <span class="nt">-X</span> POST <span class="se">\</span>
   <span class="nt">--url</span> https://&lt;your-app-name&gt;.fly.dev:10001/consumers/ <span class="se">\</span>
   <span class="nt">--data</span> <span class="s2">"username=admin"</span>
</code></pre></div><p>And add an API Key:</p>
<div class='highlight relative group '><button class='group-hover:opacity-100 opacity-0 transition-all absolute right-0 top-0 z-20 w-12 h-12 p-4 text-gray-400 hover:text-white z-10 outline-none focus:outline-none' aria-label='Copy' data-copy-target='sibling' data-copy-success="%3Csvg viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg' stroke-linecap='round' stroke-width='2' stroke='white' fill='none' stroke='currentColor' %3E%3Cpath d='m16.376 7.924-6.043 8.095-2.895-3.354' /%3E%3Cpath d='M6 2h12c2.208 0 4 1.792 4 4v12c0 2.208-1.792 4-4 4H6c-2.208 0-4-1.792-4-4V6c0-2.208 1.792-4 4-4Z' /%3E%3C/svg%3E"><svg class='pointer-events-none' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'><path d='M15.79 10.869a2.66 2.66 0 0 0-2.659-2.659H5.154a2.66 2.66 0 0 0-2.659 2.659v7.977a2.66 2.66 0 0 0 2.659 2.659h7.977a2.66 2.66 0 0 0 2.659-2.659v-7.977Z' /><path d='M15.79 15.758h3.089a2.661 2.661 0 0 0 2.659-2.66V5.121a2.661 2.661 0 0 0-2.659-2.659h-7.977a2.661 2.661 0 0 0-2.66 2.659v2.368' /></svg></button><pre class='highlight bash'><code>curl <span class="nt">-i</span> <span class="nt">-X</span> POST <span class="se">\</span>
   <span class="nt">--url</span> https://&lt;your-app-name&gt;.fly.dev:10001/consumers/admin/key-auth <span class="se">\</span>
   <span class="nt">--data</span> <span class="s2">""</span>
</code></pre></div><p>Copy the <code>key</code> that Kong returns as you&#39;ll need it to test out the API Key authentication.</p>
<p>To test that authentication is working, refresh <code>https://&lt;your-app-name&gt;.fly.dev/posts</code> in your browser. You should get a message saying, &quot;No API key found in request.&quot;</p>
<p>Next, add your API Key as a querystring parameter called <code>apikey</code>. For example, <code>https://&lt;your-app-name&gt;.fly.dev/posts?apikey=&lt;your-api-key&gt;</code>.</p>
<p>This time, you should see the list of posts returned in the previous steps. Kong is now protecting your posts Service, but your Admin API is still publicly exposed. This means anyone who knows your URL and port could create Consumers or redirect your Services to their backend.</p>
<h3 id='securing-the-kong-admin-api' class='group flex items-center whitespace-pre-wrap relative mt-14 mb-6 text-navy font-heading'><a class='absolute ml-[-1em] pr-[0.5em] after:hash opacity-0 group-hover:opacity-50 transition-all' href='#securing-the-kong-admin-api' aria-label='Anchor'></a>Securing the Kong Admin API</h3><p>Kong provides several methods for <a href="https://docs.konghq.com/2.0.x/secure-admin-api/">securing the Admin API</a>, but the simplest in a distributed hosting environment like this is to use a <a href="https://docs.konghq.com/2.0.x/secure-admin-api/#kong-api-loopback">loopback</a>. Because Kong can secure any service, you can use Kong to secure its own Admin API.</p>
<p>First, add a new service called <code>admin-api</code> which points to <code>localhost:8001</code>:</p>
<div class='highlight relative group '><button class='group-hover:opacity-100 opacity-0 transition-all absolute right-0 top-0 z-20 w-12 h-12 p-4 text-gray-400 hover:text-white z-10 outline-none focus:outline-none' aria-label='Copy' data-copy-target='sibling' data-copy-success="%3Csvg viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg' stroke-linecap='round' stroke-width='2' stroke='white' fill='none' stroke='currentColor' %3E%3Cpath d='m16.376 7.924-6.043 8.095-2.895-3.354' /%3E%3Cpath d='M6 2h12c2.208 0 4 1.792 4 4v12c0 2.208-1.792 4-4 4H6c-2.208 0-4-1.792-4-4V6c0-2.208 1.792-4 4-4Z' /%3E%3C/svg%3E"><svg class='pointer-events-none' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'><path d='M15.79 10.869a2.66 2.66 0 0 0-2.659-2.659H5.154a2.66 2.66 0 0 0-2.659 2.659v7.977a2.66 2.66 0 0 0 2.659 2.659h7.977a2.66 2.66 0 0 0 2.659-2.659v-7.977Z' /><path d='M15.79 15.758h3.089a2.661 2.661 0 0 0 2.659-2.66V5.121a2.661 2.661 0 0 0-2.659-2.659h-7.977a2.661 2.661 0 0 0-2.66 2.659v2.368' /></svg></button><pre class='highlight bash'><code>curl <span class="nt">-i</span> <span class="nt">-X</span> POST https://&lt;your-app-name&gt;.fly.dev:10001/services <span class="se">\</span>
    <span class="nt">--data</span> <span class="s2">"name=admin-api"</span> <span class="se">\</span>
    <span class="nt">--data</span> <span class="s2">"host=localhost"</span> <span class="se">\</span>
    <span class="nt">--data</span> <span class="s2">"port=8001"</span>
</code></pre></div><p>And a new Route to access this service:</p>
<div class='highlight relative group '><button class='group-hover:opacity-100 opacity-0 transition-all absolute right-0 top-0 z-20 w-12 h-12 p-4 text-gray-400 hover:text-white z-10 outline-none focus:outline-none' aria-label='Copy' data-copy-target='sibling' data-copy-success="%3Csvg viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg' stroke-linecap='round' stroke-width='2' stroke='white' fill='none' stroke='currentColor' %3E%3Cpath d='m16.376 7.924-6.043 8.095-2.895-3.354' /%3E%3Cpath d='M6 2h12c2.208 0 4 1.792 4 4v12c0 2.208-1.792 4-4 4H6c-2.208 0-4-1.792-4-4V6c0-2.208 1.792-4 4-4Z' /%3E%3C/svg%3E"><svg class='pointer-events-none' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'><path d='M15.79 10.869a2.66 2.66 0 0 0-2.659-2.659H5.154a2.66 2.66 0 0 0-2.659 2.659v7.977a2.66 2.66 0 0 0 2.659 2.659h7.977a2.66 2.66 0 0 0 2.659-2.659v-7.977Z' /><path d='M15.79 15.758h3.089a2.661 2.661 0 0 0 2.659-2.66V5.121a2.661 2.661 0 0 0-2.659-2.659h-7.977a2.661 2.661 0 0 0-2.66 2.659v2.368' /></svg></button><pre class='highlight '><code>curl -i -X POST https://&lt;your-app-name&gt;.fly.dev:10001/services/admin-api/routes \
  --data 'paths[]=/admin-api'
</code></pre></div><p>As you did in the previous step, add the API Key plugin to restrict this service to authenticated consumers:</p>
<div class='highlight relative group '><button class='group-hover:opacity-100 opacity-0 transition-all absolute right-0 top-0 z-20 w-12 h-12 p-4 text-gray-400 hover:text-white z-10 outline-none focus:outline-none' aria-label='Copy' data-copy-target='sibling' data-copy-success="%3Csvg viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg' stroke-linecap='round' stroke-width='2' stroke='white' fill='none' stroke='currentColor' %3E%3Cpath d='m16.376 7.924-6.043 8.095-2.895-3.354' /%3E%3Cpath d='M6 2h12c2.208 0 4 1.792 4 4v12c0 2.208-1.792 4-4 4H6c-2.208 0-4-1.792-4-4V6c0-2.208 1.792-4 4-4Z' /%3E%3C/svg%3E"><svg class='pointer-events-none' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'><path d='M15.79 10.869a2.66 2.66 0 0 0-2.659-2.659H5.154a2.66 2.66 0 0 0-2.659 2.659v7.977a2.66 2.66 0 0 0 2.659 2.659h7.977a2.66 2.66 0 0 0 2.659-2.659v-7.977Z' /><path d='M15.79 15.758h3.089a2.661 2.661 0 0 0 2.659-2.66V5.121a2.661 2.661 0 0 0-2.659-2.659h-7.977a2.661 2.661 0 0 0-2.66 2.659v2.368' /></svg></button><pre class='highlight bash'><code>curl <span class="nt">-i</span> <span class="nt">-X</span> POST <span class="se">\</span>
   <span class="nt">--url</span> https://&lt;your-app-name&gt;.fly.dev:10001/services/admin-api/plugins/ <span class="se">\</span>
   <span class="nt">--data</span> <span class="s1">'name=key-auth'</span> <span class="se">\</span>
   <span class="nt">--data</span> <span class="s1">'config.hide_credentials=true'</span>
</code></pre></div><p>You can now access the Kong Admin API openly at <code>https://&lt;your-app-name&gt;.fly.dev:10001</code> or using a valid API key at <code>https://&lt;your-app-name&gt;.fly.dev/admin-api?apikey=&lt;your-api-key&gt;</code>. To shut off open access, you just need to update your <code>fly.toml</code> file and re-deploy Kong.</p>
<p>Remove the Kong Admin portion of the <code>fly.toml</code> file:</p>
<div class='highlight relative group '><button class='group-hover:opacity-100 opacity-0 transition-all absolute right-0 top-0 z-20 w-12 h-12 p-4 text-gray-400 hover:text-white z-10 outline-none focus:outline-none' aria-label='Copy' data-copy-target='sibling' data-copy-success="%3Csvg viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg' stroke-linecap='round' stroke-width='2' stroke='white' fill='none' stroke='currentColor' %3E%3Cpath d='m16.376 7.924-6.043 8.095-2.895-3.354' /%3E%3Cpath d='M6 2h12c2.208 0 4 1.792 4 4v12c0 2.208-1.792 4-4 4H6c-2.208 0-4-1.792-4-4V6c0-2.208 1.792-4 4-4Z' /%3E%3C/svg%3E"><svg class='pointer-events-none' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'><path d='M15.79 10.869a2.66 2.66 0 0 0-2.659-2.659H5.154a2.66 2.66 0 0 0-2.659 2.659v7.977a2.66 2.66 0 0 0 2.659 2.659h7.977a2.66 2.66 0 0 0 2.659-2.659v-7.977Z' /><path d='M15.79 15.758h3.089a2.661 2.661 0 0 0 2.659-2.66V5.121a2.661 2.661 0 0 0-2.659-2.659h-7.977a2.661 2.661 0 0 0-2.66 2.659v2.368' /></svg></button><pre class='highlight toml'><code><span class="err">...</span>
<span class="c"># Remove this:</span>
<span class="nn">[[services]]</span>
  <span class="py">internal_port</span> <span class="p">=</span> <span class="mi">8001</span>
  <span class="py">protocol</span> <span class="p">=</span> <span class="s">"tcp"</span>

  <span class="nn">[[services.ports]]</span>
    <span class="py">handlers</span> <span class="p">=</span> <span class="p">[</span><span class="s">"tls"</span><span class="p">,</span> <span class="s">"http"</span><span class="p">]</span>
    <span class="py">port</span> <span class="p">=</span> <span class="s">"10001"</span>
</code></pre></div><p>And deploy Kong again:</p>
<div class='highlight relative group '><button class='group-hover:opacity-100 opacity-0 transition-all absolute right-0 top-0 z-20 w-12 h-12 p-4 text-gray-400 hover:text-white z-10 outline-none focus:outline-none' aria-label='Copy' data-copy-target='sibling' data-copy-success="%3Csvg viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg' stroke-linecap='round' stroke-width='2' stroke='white' fill='none' stroke='currentColor' %3E%3Cpath d='m16.376 7.924-6.043 8.095-2.895-3.354' /%3E%3Cpath d='M6 2h12c2.208 0 4 1.792 4 4v12c0 2.208-1.792 4-4 4H6c-2.208 0-4-1.792-4-4V6c0-2.208 1.792-4 4-4Z' /%3E%3C/svg%3E"><svg class='pointer-events-none' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'><path d='M15.79 10.869a2.66 2.66 0 0 0-2.659-2.659H5.154a2.66 2.66 0 0 0-2.659 2.659v7.977a2.66 2.66 0 0 0 2.659 2.659h7.977a2.66 2.66 0 0 0 2.659-2.659v-7.977Z' /><path d='M15.79 15.758h3.089a2.661 2.661 0 0 0 2.659-2.66V5.121a2.661 2.661 0 0 0-2.659-2.659h-7.977a2.661 2.661 0 0 0-2.66 2.659v2.368' /></svg></button><pre class='highlight bash'><code>flyctl deploy
</code></pre></div><p>Once your API Gateway is running again, you&#39;ll only be able to access the Admin API through <code>https://&lt;your-app-name&gt;.fly.dev/admin-api?apikey=&lt;your-api-key&gt;</code> with a valid API key.</p>
<h2 id='conclusion' class='group flex items-center whitespace-pre-wrap relative mt-14 mb-6 text-navy font-heading'><a class='absolute ml-[-1em] pr-[0.5em] after:hash opacity-0 group-hover:opacity-50 transition-all' href='#conclusion' aria-label='Anchor'></a>Conclusion</h2><p>In this post, you&#39;ve seen how to use Kong API Gateway to add rate limiting and API key authentication to your backend services. You&#39;ve deployed Kong to Fly&#39;s distributed hosting platform to take advantage of their global network and secured your Kong Admin Portal to limit access. If you&#39;re looking to add more functionality to your gateway, be sure to <a href="https://docs.konghq.com/hub/">check out the Kong Plugins directory</a>.</p>
<p>If you have any questions about using Kong with <a href="https://fly.io/">Fly.io</a>, be sure to reach out so we can help you get started.</p>
